---
title: "Lab 04 - Predicting MHV Change"
author: "Group 03"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    df_print: paged
  bookdown::html_document2:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
``` 


This lab is designed to help you build your baseline model of neighborhood change before adding the policy variables in the next lab.


<br>
<br>

# Part 1 - Data

The following data steps are now completed in the source_file_rn.R:

    - Similar to your previous lab, create a dataset that includes 2000 and 2010 census variables drop all rural census tracts.
    - Create a variable that measures the growth of median home value from 2000 to 2010.
    - Omit cases that have a median home value less than $10,000 in 2000.
    - Omit cases with growth rates above 200%.


  <br>
  <br>


### Load necessary packages:

```{r, message = F, warning = F}

library( dplyr )
library( here )
library( knitr )
library( pander )
library( stargazer )
library( scales )
library( plm )
library( evaluate )
```

<br>
<br>

### Load your wrangled datasets and prepare your variables for analysis:

```{r}

# load necessary functions and objects ----
# note: all of these are R objects that will be used throughout this .rmd file
import::here("S_TYPE",
             "panel.cor",
             "panel.smooth",
             "jplot",
             "d",
             "df",
             "cbsa_stats_df",
             "mhv.00",
             # notice the use of here::here() that points to the .R file
             # where all these R objects are created
             .from = here::here("labs/wk06/source_file_rn.R"),
             .character_only = TRUE)
```

```{r}
df %>% head()
```


## Descriptives

```{r, results = 'asis'}
stargazer( df, 
           type = S_TYPE, 
           digits = 0, 
           summary.stat = c("min", "p25","median","mean","p75","max") )
```

## Metro Level Statistics

```{r}
# view results
cbsa_stats_df %>% head()
```

<br>
<br>

## Median Home value

```{r}

hist( mhv.00, breaks=200, xlim=c(0,500000), 
      col="gray20", border="white",
      axes=F, 
      xlab="MHV (median = $138k)",
      ylab="",
      main="Median Home Value in 2000 (2010 US dollars)" )

axis( side=1, at=seq(0,500000,100000), 
      labels=c("$0","$100k","$200k","$300k","$400k","$500k") )

abline( v=median( mhv.00, na.rm=T ), col="orange", lwd=3 )

```

<br>

## Change in MHV 2000-2010

The change in value variable only reports absolute change, but does not provide a sense of whether that is a big or small amount for the census tract.

```{r}
hist( df$MHV.Change.00.to.10 / 1000, breaks = 500, 
      xlim = c(-100,500), yaxt = "n", xaxt = "n",
      xlab = "Thousand of US Dollars (adjusted to 2010)", cex.lab = 1.5,
      ylab = "", main = "Change in Median Home Value 2000 to 2010",
      col = "gray20", border = "white" )
axis( side=1, at=seq( from = -100, to = 500, by = 100 ), 
      labels=paste0( "$", seq( from = -100, to = 500, by = 100 ), "k" ) )
        
mean.x <- mean( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=200, y=1500, 
      labels=paste0( "Mean = ", dollar( round(1000*mean.x,0)) ), 
      col="darkorange", cex=1.8, pos=3 )
median.x <- median( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=200, y=2000, 
      labels=paste0( "Median = ", dollar( round(1000*median.x,0)) ), 
      col="dodgerblue", cex=1.8, pos=3 )
```

<br>
<br>

# Part 2 - Predict MHV Change

## Select at least three census variables that you feel will be good predictors of change in MHV between 2000 and 2010.

    - Percent White
    - Percent High School Education
    - Percent Professional

```{r, warning = F}
# create subset to visualize in correlation matrix 
d4 <- select( d, pct.change, p.white.00, p.hs.edu.00,  p.col.edu.00 )

# skewed - use log transformation
par( mfrow = c(1,2) )
hist( d4$p.white.00, breaks = 50, col = "gray20", border = "white",
      yaxt = "n", xlab = "", ylab = "", main = "Percent White")
hist( log10(d4$p.white.00 + 1), breaks = 50, col = "gray20", border = "white",
      yaxt = "n", xlab = "", ylab = "", main = "Percent White (logged)")

# No skew 
par( mfrow = c(1,2) )
hist( d4$p.hs.edu.00, breaks = 50, col = "gray20", border = "white",
      yaxt = "n", xlab = "", ylab = "", main = "Percent HS Education")
hist( log10(d4$p.hs.edu.00 + 1), breaks = 50, col = "gray20", border = "white",
      yaxt = "n", xlab = "", ylab = "", main = "Percent HS Education (logged)")

# skewed - use log transformation
par( mfrow = c(1,2) )
hist( d4$p.col.edu.00, breaks = 50, col = "gray20", border = "white",
      yaxt = "n", xlab = "", ylab = "", main = "Percent College Education")
hist( log10(d4$p.col.edu.00 + 1), breaks = 50, col = "gray20", border = "white",
      yaxt = "n", xlab = "", ylab = "", main = "Percent College Education (logged)")

```

After applying log transformations:

```{r}

set.seed( 1234 ) # set randomization seed
# recode some vars to remove outliers and skew
d4$p.white.00 <- log10( d4$p.white.00 + 1 )
d4$p.col.edu.00 <- log10( d4$p.col.edu.00 + 1 )

d4.sample <- sample_n( d4, 5000 ) %>% na.omit()

pairs( d4.sample, upper.panel=panel.cor, lower.panel=panel.smooth )
```

### Run the model while including metro-level fixed effects (cbsa name or FIPS). 

Check for multicollinearity:

```{r, results = 'asis'}
d.reg <- d
d.reg$pct.change[ d.reg$pct.change > 200 ] <- NA
d.reg$p.white.00 <- log10( d.reg$p.white.00 + 1 )
d.reg$p.col.edu.00 <- log10( d.reg$p.col.edu.00 + 1 )

m1 <- lm( pct.change ~  p.hs.edu.00, data=d.reg ) # suspicious variable
m2 <- lm( pct.change ~  p.col.edu.00, data=d.reg ) # suspicious variable
m3 <- lm( pct.change ~  p.hs.edu.00 + p.col.edu.00, data=d.reg ) # test for multicollinearity

stargazer( m1, m2, m3,
           type = "text", digits = 2,
           omit.stat = c("rsq","f") )

```

Since coefficient sizes are larger, standard errors are the same, R-square stayed the same, multicollinearity between the two suspicious variables, p.hs.edu.00 and p.col.edu.00 may not be a concern.


### Fixed effect model


```{r}
model.ols <- lm( pct.change ~  p.white.00 + p.hs.edu.00 + p.col.edu.00, 
                 data = d.reg)

model.fe <- plm( pct.change ~  p.white.00 + p.hs.edu.00 + p.col.edu.00,
               index=c("cbsaname"), 
               data = d.reg)

stargazer( model.ols, model.fe, 
           type = "text", 
           dep.var.labels = ("Percent MHV Change"),
           column.labels = c("OLS", "Fixed effects"), 
           intercept.bottom = FALSE,
           omit.stat = "all", 
           digits = 2 )
```

<br>
<br>

### What are the results? Which factor was most important? Did it meet your expectations? Were there any variables that were not significant that you expected to be?

According to the fixed effects results model, all variable coefficients were statistically significant. Percent White had the largest effect on the Percent MHV Change. Metro areas with larger proportions of white individuals were hypothesized to correlate with higher median home values and larger home growth.   

```{r}
fixef(model.fe)

pFtest(model.fe, model.ols) 
```


<br>
<br>

